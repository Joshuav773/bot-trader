version: '3.8'

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bot-trader-api
    ports:
      - "8000:8000"
    environment:
      # API Keys
      - POLYGON_API_KEY=${POLYGON_API_KEY}
      - ALPACA_API_KEY=${ALPACA_API_KEY}
      - ALPACA_SECRET_KEY=${ALPACA_SECRET_KEY}
      
      # Database
      - DATABASE_URL=${DATABASE_URL:-postgresql+psycopg://postgres:postgres@postgres:5432/bottrader}
      
      # JWT Settings
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - JWT_ALGORITHM=${JWT_ALGORITHM:-HS256}
      - JWT_EXPIRES_MIN=${JWT_EXPIRES_MIN:-60}
      
      # CORS - Easy to change!
      - CORS_ALLOW_ORIGINS=${CORS_ALLOW_ORIGINS:-http://localhost:3000,http://127.0.0.1:3000}
      
      # Admin User
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@example.com}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      
      # Polygon Data Limits
      - POLYGON_LIMIT_5M=${POLYGON_LIMIT_5M:-30}
      - POLYGON_LIMIT_15M=${POLYGON_LIMIT_15M:-60}
      - POLYGON_LIMIT_30M=${POLYGON_LIMIT_30M:-90}
      - POLYGON_LIMIT_1H=${POLYGON_LIMIT_1H:-730}
      - POLYGON_LIMIT_4H=${POLYGON_LIMIT_4H:-730}
      - POLYGON_LIMIT_1D=${POLYGON_LIMIT_1D:-3650}
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - bot-trader-network

  postgres:
    image: postgres:15-alpine
    container_name: bot-trader-db
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-bottrader}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - bot-trader-network

volumes:
  postgres_data:

networks:
  bot-trader-network:
    driver: bridge

